
---

- name: "deploy play."
  hosts: web
  user: ubuntu
  gather_facts: false
  vars:
    - ansible_python_interpreter: /usr/bin/python3
    - ANSIBLE_HOST_KEY_CHECKING: false
    - ansible_stdout_callback: yaml

  environment:
    ANSIBLE_HOST_KEY_CHECKING: false
    ENVIRONMENT: production
    TYPEORM_CONNECTION: postgres
    TYPEORM_ENTITIES: ./src/modules/domain/**/*.entity.ts
    TYPEORM_HOST: project3.cmill571hyhm.us-west-2.rds.amazonaws.com
    TYPEORM_PORT: 5432
    TYPEORM_USERNAME: postgres
    TYPEORM_PASSWORD: project3
    TYPEORM_DATABASE: postgres

  tasks:

  - name: Make Project Folder
    shell: mkdir ~/project3

  - name: Git Checkout
    git:
      repo: https://github.com/Fontaineconsult/UCDOEND_Project3.git
      dest: ~/project3

  - name: install packages
    shell: |
      cd ~/project3/backend
      npm install

  - name: "Take a look"
    shell: |
      ls ~/project3/backend

  - name: Start Migration
    shell: |
      cd ~/project3/backend
      npm run migrations > output.txt


  - name: Save ouput to memstash if success
    shell: |
      if grep "has been executed successfully" output.txt;
      then curl -H "Content-Type: text/plain" -H "token: 7cb66ce8-9b24-4bbd-9b69-31b5ca339fc1" --request PUT --data "0" https://api.memstash.io/values/$(< roles/deploy-backend/files/wid.txt);
      fi

  - name: Save ouput to memstash if fail
    shell: |
      if ! grep "has been executed successfully" output.txt;
      then curl -H "Content-Type: text/plain" -H "token: 7cb66ce8-9b24-4bbd-9b69-31b5ca339fc1" --request PUT --data "1" https://api.memstash.io/values/$(< roles/deploy-backend/files/wid.txt);
      fi




